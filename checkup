#!/usr/bin/php
<?php

$checkup = [
    // Strategy
    '/teamplay/enable' => 'true',
    '/decision/cooperation' => 'true',
    '/decision/enableShare' => 'true',
    '/moves/robocup/headMove' => 'Head2',
    '/moves/playing/approachMove' => 'approach_potential',
    '/moves/playing/useKickController' => 'true',
    '/moves/approach_potential/enableLateral' => 'true',

    // Behavior
    '/moves/robocup/delayStart' => 0,
    '/moves/placer/directMode' => 'true',
    '/moves/playing/localizeWalkDuration' => 10,
    '/moves/search/rotateAfter' => 3,

    // Pressure
    '/decision/lowPressureThreshold' => 60000,
    '/pressure/normalWeight' => 150000,

    // Locmotion
    '/moves/walk/maxStep' => 40,
    '/moves/walk/warmup' => 0.6,
    '/moves/walk/maxDStepByCycle' => 10,
    '/moves/walk/maxDLatByCycle' => 5,
    '/moves/walk/maxDTurnByCycle' => 2.5,
    '/moves/approach_potential/stepP' => 1,

    // Filters
    '/Localisation/Field/RobotController/angleExploration' => 5,
    '/Localisation/Field/RobotController/posExploration' => 25,
    '/Localisation/Field/FieldPF/fallNoiseTheta' => 20,
    '/Localisation/Field/FieldPF/fallNoise' => 25,
    '/Localisation/Field/GoalObservation/maxAngleError' => 10,
    '/Localisation/Field/GoalObservation/maxTiltAllowed' => 80,
    '/ballStack/farBall' => 4,

    // Head tilts
    '/moves/head/minTilt' => 10,
    '/moves/head/maxTilt' => 70,
    '/moves/head/scanTiltNbPos' => 3,
    '/moves/head/scanPanNbPos' => 8,
    '/moves/Head2/maxSpeed' => 180,

    // I hope we won't neet that
    '/moves/penalty/startX' => 200,
];

function question($msg) {
    while (true) {
        echo "\n\e[1m$msg\e[m (y/n)\n";
        echo "> ";
        flush();
        $m = trim(readline());
        if ($m == 'y') return true;
        if ($m == 'n') return false;
        echo "You should answer 'y' or 'n'\n";
    }
}

$host = '10.0.0.1';
if (count($argv) >= 2) {
    $host = $argv[1];
}

function error($msg)
{
    echo "\e[31;1m$msg\n";
}

function warning($msg)
{
    echo "\e[33;1m$msg\n";
}

function success($msg)
{
    echo "\e[32;1m$msg\n";
}

function cmd($cmd) {
    global $host;
    $result = trim(`rhio $host $cmd`);
    return $result;
}

echo "\n\e[1mChecking up RhIO values [$host]\n";
$changes = false;

foreach ($checkup as $node => $value) {
    $return = cmd($node);
    $parts = explode('=', $return, 2);
    if (count($parts) == 2) {
        $v = $parts[1];
        if ($v == $value) {
            success("* $node=$value");
        } else {
            error("* $node=$v, should be $value");
            if (question('Fix it?')) {
                cmd("$node=$value");
                $changes = true;
                success("-> Fixing it and saving");
                cmd("save ".dirname($node));
            }
        }
    } else {
        error("Can't find value $node");
    }
}

echo "\e[m\n";
